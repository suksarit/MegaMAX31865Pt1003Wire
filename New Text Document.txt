======================================================================
คู่มือการทำงานและวิธีใช้งาน
ระบบวัดอุณหภูมิ Pt100 ด้วย MAX31865 (Non-Blocking)
======================================================================

[1] ภาพรวมระบบ
----------------------------------------------------------------------
โค้ดนี้ใช้ Arduino (เช่น Mega 2560) ร่วมกับโมดูล MAX31865
สำหรับอ่านค่าอุณหภูมิจากเซนเซอร์ Pt100 แบบ 3-Wire
โดยออกแบบให้ทำงานแบบ Non-Blocking (ไม่ใช้ delay)

คุณสมบัติหลัก:
- อ่านอุณหภูมิเฉพาะเมื่อถึงเวลาที่จำเป็น
- แยกการ "อ่านค่า" และ "แสดงผล" ออกจากกัน
- ตรวจสอบ Fault ของ MAX31865 ทุกครั้งที่อ่านค่า
- ไม่กระทบ loop หลักหรือระบบอื่น (มอเตอร์ / protection ฯลฯ)

เหมาะสำหรับ:
- ระบบควบคุมมอเตอร์
- รถบังคับ / รถเกษตร
- ระบบที่ต้องการ loop ทำงานต่อเนื่องตลอดเวลา


[2] ไลบรารีที่ใช้
----------------------------------------------------------------------
#include <SPI.h>
#include <Adafruit_MAX31865.h>

ต้องติดตั้ง:
- Adafruit MAX31865 Library
- Adafruit BusIO (dependency)

ติดตั้งผ่าน Arduino Library Manager ได้โดยตรง


[3] การกำหนดขา (PIN CONFIG)
----------------------------------------------------------------------
#define MAX31865_CS 49

- ใช้ SPI Hardware ของบอร์ด
- CS (Chip Select) ต่อเข้าขา Digital 49
- ขาอื่นของ SPI:
  - SCK  → ขา SPI ของบอร์ด
  - MOSI → ขา SPI ของบอร์ด
  - MISO → ขา SPI ของบอร์ด


[4] การตั้งค่า RTD (Pt100)
----------------------------------------------------------------------
#define RNOMINAL 100.0
#define RREF     430.0

ความหมาย:
- RNOMINAL = ค่าโอห์มของ Pt100 ที่ 0°C (100Ω)
- RREF     = ค่า Reference Resistor บนบอร์ด MAX31865
             (ส่วนใหญ่ใช้ 430Ω ตามบอร์ดมาตรฐาน)

หากใช้ Pt1000:
- RNOMINAL = 1000.0
- RREF ต้องเปลี่ยนตามฮาร์ดแวร์


[5] การตั้งค่าเวลา (TIMING CONFIG)
----------------------------------------------------------------------
#define TEMP_READ_INTERVAL   1000
#define TEMP_PRINT_INTERVAL  1000

หน่วยเป็น millisecond

- TEMP_READ_INTERVAL:
  อ่านอุณหภูมิทุก 1 วินาที
- TEMP_PRINT_INTERVAL:
  แสดงผลทาง Serial ทุก 1 วินาที

สามารถปรับค่าได้โดยไม่กระทบโครงสร้างโค้ด


[6] ตัวแปรสถานะ (GLOBAL STATE)
----------------------------------------------------------------------
float currentTemperature = NAN;
uint8_t lastFault = 0;

unsigned long lastTempReadTime;
unsigned long lastTempPrintTime;

หน้าที่:
- currentTemperature : เก็บค่าอุณหภูมิล่าสุด
- lastFault          : เก็บสถานะ Fault ล่าสุดจาก MAX31865
- lastTempReadTime   : เวลาที่อ่านอุณหภูมิล่าสุด
- lastTempPrintTime  : เวลาที่แสดงผลล่าสุด


[7] การทำงานใน setup()
----------------------------------------------------------------------
void setup() {
  Serial.begin(115200);
  delay(500);

  rtd.begin(MAX31865_3WIRE);

  Serial.println("MAX31865 Pt100 Non-blocking Ready");
}

ขั้นตอน:
1) เปิด Serial ที่ 115200 baud
2) เริ่มต้น MAX31865 ในโหมด 3-Wire
3) แสดงข้อความยืนยันระบบพร้อมทำงาน


[8] หลักการทำงานใน loop()
----------------------------------------------------------------------
loop() แบ่งออกเป็น 2 ส่วนอิสระจากกัน

------------------------------------------------
(1) อ่านอุณหภูมิเมื่อถึงเวลา
------------------------------------------------
เงื่อนไข:
if (now - lastTempReadTime >= TEMP_READ_INTERVAL)

การทำงาน:
- อ่านค่าอุณหภูมิจาก Pt100
- อ่านค่า Fault จาก MAX31865
- หากพบ Fault จะสั่ง clearFault() ทันที

จุดสำคัญ:
- ไม่มี delay
- ไม่อ่านถี่เกินจำเป็น
- เหมาะกับระบบ real-time


------------------------------------------------
(2) แสดงผลเมื่อถึงเวลา
------------------------------------------------
เงื่อนไข:
if (now - lastTempPrintTime >= TEMP_PRINT_INTERVAL)

การทำงาน:
- หากมี Fault → แสดงชนิด Fault แบบละเอียด
- หากไม่มี Fault → แสดงค่าอุณหภูมิ

Fault ที่ตรวจสอบ:
- High Threshold
- Low Threshold
- REFIN ผิดปกติ
- RTD open
- Under / Over Voltage


[9] รูปแบบผลลัพธ์ทาง Serial
----------------------------------------------------------------------
กรณีปกติ:
Temperature: 27.53 °C

กรณีเกิด Fault:
RTD Fault Detected:
 - RTDIN- open
 - Under/Over Voltage


[10] ข้อดีของโครงสร้างนี้
----------------------------------------------------------------------
✔ Non-Blocking 100%
✔ ไม่กระทบงานอื่นใน loop
✔ อ่านอุณหภูมิเท่าที่จำเป็น
✔ เหมาะกับระบบควบคุมมอเตอร์จริง
✔ สามารถนำไปต่อยอด Protection / Logging / PID ได้ทันที


[11] ข้อควรระวัง
----------------------------------------------------------------------
- ตรวจสอบการต่อสาย Pt100 ให้ถูกต้อง (3-Wire)
- ใช้สายสัญญาณแบบบิดเกลียวและสั้นที่สุด
- ควรต่อ GND ร่วมกับระบบทั้งหมด
- หากใช้สายยาวมาก ควรกรองสัญญาณเพิ่ม


[12] สรุป
----------------------------------------------------------------------
โค้ดนี้เป็นโครงสร้างมาตรฐานที่ "ใช้งานจริงได้"
สำหรับระบบที่ต้องการความเสถียรและไม่รบกวน loop หลัก

สามารถนำไปใช้ร่วมกับ:
- ระบบมอเตอร์
- ระบบ Safety / Protection
- ระบบบันทึกข้อมูล (SD Card)
- ระบบควบคุมอัตโนมัติ

======================================================================
